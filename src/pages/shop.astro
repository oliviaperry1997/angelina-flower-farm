---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Background from '../components/Background.astro';
import ProductCard from '../components/ProductCard.astro';
import { products } from '../data/products';
import { getCurrentLanguage, t } from '../utils/translations';

const base = import.meta.env.BASE_URL;
const createUrl = (path: string) => base === '/' ? `/${path}/` : `${base}/${path}/`;
const currentLanguage = getCurrentLanguage();
---

<Layout title="Shop â€“ Angelina's Flower Farm">
  <Background />
  <Header />
  <main class="container mx-auto px-4 py-24">
    <h1 data-i18n="shopTitle" class="text-4xl md:text-5xl font-bold text-white drop-shadow-2xl mb-4">
      {t('shopTitle', currentLanguage)}
    </h1>
    <p data-i18n="shopSubtitle" class="text-white/90 mb-12 max-w-2xl drop-shadow">
      {t('shopSubtitle', currentLanguage)}
    </p>

    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {products.map((product) => (
        <ProductCard product={product} />
      ))}
    </div>

    <div class="mt-12 bg-white/80 backdrop-blur-sm rounded-xl border border-white/40 shadow-sm p-8 text-center">
      <h2 data-i18n="customOrders" class="text-2xl font-semibold text-gray-900 mb-3">
        {t('customOrders', currentLanguage)}
      </h2>
      <p data-i18n="customOrdersDesc" class="text-gray-600 mb-6">
        {t('customOrdersDesc', currentLanguage)}
      </p>
      <a href={createUrl('contact')} data-i18n="contactUs" class="inline-block bg-green-600 text-white py-3 px-8 rounded-full font-semibold hover:bg-green-700 transition">
        {t('contactUs', currentLanguage)}
      </a>
    </div>
  </main>
</Layout>

<script>
  import { translations, getCurrentLanguage, type Lang } from '../utils/translations';
  import { CartManager } from '../utils/cart';

  function updateShopTranslations(lang: Lang) {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach((el) => {
      const key = el.getAttribute('data-i18n');
      if (key && key in translations[lang]) {
        el.textContent = translations[lang][key as keyof typeof translations.en];
      }
    });
  }

  // Add to cart functionality
  function setupAddToCartButtons() {
    const buttons = document.querySelectorAll('.add-to-cart-btn');
    
    buttons.forEach(button => {
      button.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const id = target.getAttribute('data-id');
        const nameKey = target.getAttribute('data-name-key'); // Use translation key instead
        const priceStr = target.getAttribute('data-price');
        
        if (id && nameKey && priceStr) {
          const price = parseFloat(priceStr);
          const currentLang = getCurrentLanguage();
          
          // Get translated product name
          const translatedName = translations[currentLang][nameKey as keyof typeof translations.en];
          
          CartManager.addItem(id, translatedName, price, nameKey);
          
          // Visual feedback
          const originalText = target.textContent;
          target.textContent = 'Added!';
          target.classList.add('bg-green-700');
          
          setTimeout(() => {
            target.textContent = originalText;
            target.classList.remove('bg-green-700');
          }, 1000);
        }
      });
    });
  }

  // Initialize with current language
  updateShopTranslations(getCurrentLanguage());
  setupAddToCartButtons();

  // Listen for language changes
  window.addEventListener('languageChanged', ((e: CustomEvent) => {
    updateShopTranslations(e.detail.lang);
  }) as EventListener);
</script>
