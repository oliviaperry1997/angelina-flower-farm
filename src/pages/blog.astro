---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Background from '../components/Background.astro';

const posts = await Astro.glob('./posts/*.md');
// Sort newest first by pubDate if present
posts.sort((a, b) => {
  const da = new Date(a.frontmatter?.pubDate ?? 0).getTime();
  const db = new Date(b.frontmatter?.pubDate ?? 0).getTime();
  return db - da;
});
---

<Layout title="Blog â€“ Angelina's Flower Farm">
  <Background />
  <Header />
  <main class="container mx-auto px-4 py-24">
    <h1 data-i18n="blogTitle" class="text-4xl md:text-5xl font-bold text-white drop-shadow-2xl mb-4">Farm Journal</h1>
    <p data-i18n="blogSubtitle" class="text-white/90 mb-12 max-w-2xl drop-shadow">Stories from the field: seasonal blooms, growing tips, and updates from our family farm.</p>

    <div class="grid gap-8 md:grid-cols-2">
      {posts.map((post) => (
        <a href={post.url} class="group block bg-white/80 backdrop-blur-sm rounded-xl border border-white/40 shadow-sm hover:shadow-md transition overflow-hidden">
          <div class="p-6">
            <h2 class="text-2xl font-semibold text-gray-900 group-hover:text-green-700 transition">
              {post.frontmatter.title}
            </h2>
            {post.frontmatter.description && (
              <p class="mt-3 text-gray-600">{post.frontmatter.description}</p>
            )}
            {post.frontmatter.pubDate && (
              <p class="mt-4 text-sm text-gray-500">
                {new Date(post.frontmatter.pubDate).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}
              </p>
            )}
          </div>
        </a>
      ))}
    </div>

    {posts.length === 0 && (
      <p data-i18n="noPosts" class="text-white/80">No posts yet. Check back soon!</p>
    )}
  </main>
</Layout>

<script>
  import { translations, getCurrentLanguage, type Lang } from '../utils/translations';

  function updateBlogTranslations(lang: Lang) {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach((el) => {
      const key = el.getAttribute('data-i18n');
      if (key && key in translations[lang]) {
        el.textContent = translations[lang][key as keyof typeof translations.en];
      }
    });
  }

  // Initialize with current language
  updateBlogTranslations(getCurrentLanguage());

  // Listen for language changes
  window.addEventListener('languageChanged', ((e: CustomEvent) => {
    updateBlogTranslations(e.detail.lang);
  }) as EventListener);
</script>
